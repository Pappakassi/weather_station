{% extends 'base.html' %}

{% block title %}Veﾃｰurstﾃｶﾃｰvarkort - Veﾃｰriﾃｰ hjﾃ｡ ﾃ斗a Bj.{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .map-controls {
        background: var(--dark-card);
        border: 1px solid var(--dark-border);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .control-button {
        background: var(--dark-surface);
        border: 1px solid var(--dark-border);
        color: var(--text-primary);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        margin-right: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .control-button:hover {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
    }
    
    .map-info {
        background: var(--dark-surface);
        border: 1px solid var(--dark-border);
        border-radius: 12px;
        padding: 1.5rem;
    }
    
    #weatherMap {
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--dark-border);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="weather-card">
                <h1 class="gradient-text mb-3">
                    <i class="bi bi-geo-alt me-2"></i>
                    Staﾃｰsetning Veﾃｰurstﾃｶﾃｰvar
                </h1>
                <p class="text-muted">Gagnvirkt kort sem sﾃｽnir staﾃｰsetningu Akureyrar veﾃｰurstﾃｶﾃｰvar</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Map Controls -->
        <div class="col-lg-3 mb-4">
            <div class="map-controls">
                <h5 class="text-primary mb-3">Kortstﾃｽring</h5>
                <button class="control-button" onclick="zoomToStation()">
                    <i class="bi bi-zoom-in me-2"></i>Stﾃｦkka aﾃｰ stﾃｶﾃｰ
                </button>
                <button class="control-button" onclick="toggleSatellite()">
                    <i class="bi bi-globe me-2"></i>Gervihnattayfirlit
                </button>
                <button class="control-button" onclick="showWeatherLayer()">
                    <i class="bi bi-cloud me-2"></i>Veﾃｰurlag
                </button>
            </div>

            <div class="map-info">
                <h6 class="text-primary mb-3">Upplﾃｽsingar um stﾃｶﾃｰ</h6>
                <div class="mb-2">
                    <strong>Nafn:</strong> {{ station_name }}
                </div>
                <div class="mb-2">
                    <strong>Breidd:</strong> {{ station_lat }}ﾂｰN
                </div>
                <div class="mb-2">
                    <strong>Lengd:</strong> {{ station_lng }}ﾂｰW
                </div>
                <div class="mb-2">
                    <strong>Hﾃｦﾃｰ:</strong> ~30m yfir sjﾃ｡varmﾃ｡li
                </div>
                <div class="mb-2">
                    <strong>Tegund stﾃｶﾃｰvar:</strong> Sjﾃ｡lfvirk veﾃｰurstﾃｶﾃｰ
                </div>
                <div class="mb-3">
                    <strong>Gagnagjafi:</strong> Veﾃｰurstofa ﾃ行lands
                </div>
                
                <div class="mt-3">
                    <a href="{% url 'weather:dashboard' %}" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-left me-2"></i>Til baka ﾃ｡ stjﾃｳrnborﾃｰ
                    </a>
                </div>
            </div>
        </div>

        <!-- Interactive Map -->
        <div class="col-lg-9 mb-4">
            <div class="weather-card">
                <div id="weatherMap" style="height: 600px; width: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- Additional Information -->
    <div class="row">
        <div class="col-12">
            <div class="weather-card">
                <h5 class="gradient-text mb-3">Um Akureyrar veﾃｰurstﾃｶﾃｰ</h5>
                <div class="row">
                    <div class="col-md-8">
                        <p class="text-muted mb-3">
                            Akureyrar veﾃｰurstﾃｶﾃｰ er staﾃｰsett ﾃ｡ Norﾃｰur-ﾃ行landi og veitir rauntﾃｭma veﾃｰurgﾃｶgn
                            ﾃｾar meﾃｰ taliﾃｰ hitastig, raka, vindhraﾃｰa og stefnu, ﾃｺrkomu og loftﾃｾrﾃｽsting.
                        </p>
                        <p class="text-muted mb-3">
                            Akureyri er nﾃｦststﾃｦrsta ﾃｾﾃｩttbﾃｽli ﾃ行lands og stﾃｦrsti bﾃｦrinn ﾃ｡ norﾃｰursvﾃｦﾃｰinu. 
                            Veﾃｰurstﾃｶﾃｰin ﾃｾjﾃｳnar sem mikilvﾃｦgur mﾃｦlingarpunktur fyrir arkurskipulag
                            sem einkennir ﾃｾetta svﾃｦﾃｰi.
                        </p>
                        <p class="text-muted">
                            Gﾃｶgn eru safnaﾃｰ stﾃｶﾃｰugt og uppfﾃｦrﾃｰ reglulega ﾃｭ gegnum net Veﾃｰurstofu ﾃ行lands
                            af sjﾃ｡lfvirkum veﾃｰurstﾃｶﾃｰvum um allt land.
                        </p>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card text-center">
                            <i class="bi bi-thermometer-half metric-icon"></i>
                            <div class="metric-value">24/7</div>
                            <div class="metric-label">Gagnasﾃｶfnun</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Django template variables passed to JavaScript
    const stationLat = {{ station_lat }};
    const stationLng = {{ station_lng }};
    const stationName = "{{ station_name }}";

    let map;
    let stationMarker;
    let satelliteLayer;
    let standardLayer;
    let currentLayer = 'standard';

    // Initialize the map
    function initializeMap() {
        console.log('Initializing map...');
        console.log('Station coordinates:', stationLat, stationLng);
        
        try {
            // Create the map
            map = L.map('weatherMap').setView([stationLat, stationLng], 10);
            console.log('Map created successfully');

            // Standard tile layer
            standardLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            });

            // Satellite layer (using Esri World Imagery)
            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            });

            // Add standard layer by default
            standardLayer.addTo(map);
            console.log('Tile layer added');

            // Custom icon for weather station - using simple HTML without CSS variables
            const stationIcon = L.divIcon({
                className: 'weather-station-marker',
                html: '<div style="background: #4c9aff; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: 2px solid white; font-size: 14px;">沒｡</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            // Add weather station marker
            stationMarker = L.marker([stationLat, stationLng], { 
                icon: stationIcon 
            }).addTo(map);
            console.log('Marker added');

            // Add popup to marker
            stationMarker.bindPopup(`
                <div style="color: #333; padding: 12px; min-width: 200px;">
                    <h6 style="margin-bottom: 8px; color: #4c9aff;">沒｡ ${stationName}</h6>
                    <p style="margin-bottom: 4px;"><strong>Hnit:</strong> ${stationLat}ﾂｰN, ${Math.abs(stationLng)}ﾂｰW</p>
                    <p style="margin-bottom: 4px;"><strong>Tegund:</strong> Sjﾃ｡lfvirk veﾃｰurstﾃｶﾃｰ</p>
                    <p style="margin-bottom: 4px;"><strong>Staﾃｰa:</strong> <span style="color: #28a745;">笨 Virk</span></p>
                    <p style="margin-bottom: 0;"><strong>Uppfﾃｦrt:</strong> Stﾃｶﾃｰugt</p>
                </div>
            `);

            // Open popup by default
            setTimeout(function() {
                stationMarker.openPopup();
            }, 500);
            
            console.log('Map initialization complete');
        } catch (error) {
            console.error('Error initializing map:', error);
        }
    }

    // Zoom to station location
    function zoomToStation() {
        map.setView([stationLat, stationLng], 15);
        stationMarker.openPopup();
    }

    // Toggle between standard and satellite view
    function toggleSatellite() {
        if (currentLayer === 'standard') {
            map.removeLayer(standardLayer);
            map.addLayer(satelliteLayer);
            currentLayer = 'satellite';
        } else {
            map.removeLayer(satelliteLayer);
            map.addLayer(standardLayer);
            currentLayer = 'standard';
        }
    }

    // Show weather layer (placeholder for future weather overlay)
    function showWeatherLayer() {
        // This would integrate with weather radar or other meteorological overlays
        alert('Weather layer functionality would be implemented here with radar data overlay.');
    }

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializeMap();
    });
</script>
{% endblock %} 